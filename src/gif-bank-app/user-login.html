<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="user-login">
  <template>
    <style>
      :host {
        display: flex;
      }

      /********** Register **********/
      #register {
        display: none;
        width: 500px;
        height: 460px;

        padding-top: 30px;
        margin: auto;

        background-color: #cccccc;
        border-radius: 20px;
        text-align: center;
      }

      .error {
        color: red;
      }

      /********** Login ***********/
      #login {
        /* CTRL-F:: DEBUG */
        display: block;

        width: 500px;
        height: 350px;

        padding-top: 30px;
        margin: auto;

        background-color: #cccccc;
        border-radius: 20px;
        text-align: center;
      }

      #credentials {
        margin: 15px 0px 0px 90px;
        top: 20px;
      }

      paper-button {
        margin-top: 20px;
        background-color: lightblue;
      }

      paper-input {
        width: 300px;
        height: 50px;

        background-color: white;
        border-radius: 5px;
      }

      /********** Header **********/
      #header {
        height: 75px;
        width: 100%;
        background-color: lightblue;
        display: flex;
      }

      #header button {
        height: 75px;
        width: 150px;
        background-color: lightblue;
        font-size: 24px;
        font-weight: bold;
        border-style: none;
      }

      #header h1 {
        padding-left: 50px;
      }

      #tabs {
        position: relative;
        left: 30%;
      }

      #tabs button:hover {
        background-color: rgb(79, 196, 231);
      }

      /*********** GiphyTable ************/

      #giphyTable {
        /* CTRL-F:: DEBUG */
        display: none;
      }

      #gif {
        padding: 10px;
      }

      #itemsList {
        width: 1000px;
        display: flex;
      }
      
      /********* Favorites **********/
      #favorites {
        display: none;
        width: 500px;
        height: 500px;
        background-color: lightblue;
        position: absolute;
        top: 300px;
        left: 500px;
      }
    </style>

    <firebase-app id="userDB"
      auth-domain="gif-bank-66e52.firebaseapp.com"
      database-url="https://gif-bank-66e52.firebaseio.com"
      api-key="AIzaSyDxiWWMWwyk8F9jUu6v7n0sNDFzl-Hl_2U"
      storage-bucket="gif-bank-66e52.appspot.com"
      messaging-sender-id="416444590172">
    </firebase-app>

    <user-register id="register"></user-register>
    
    <div id="login">
      <h1>Login</h1>
      <div id="credentials">
        <paper-input type="email" autoValidate="true" id="loginEmail" label="Email address"></paper-input>
        <paper-input autoValidate="true" id="loginPassword" label="Password" type="password"></paper-input>
      </div>
      <paper-button id="btnLogin" on-click="login">Login</paper-button> <br />
      <paper-button id="btnRegister" on-click="register">Register</paper-button>
    </div>

    <div id="register">
      <h1>Register</h1>
      <div id="credentials">
        <paper-input type="email" autoValidate="true" id="registerEmail" label="Email address"></paper-input>
        <paper-input type="password" autoValidate="true" id="registerPassword" label="Password"></paper-input>
        <paper-input id="confirmPassword" type="password" autoValidate="true" label="Confirm Password"></paper-input>
      </div>
      <p id="userError" class="error" style="display: none;">This username is already taken</p>
      <paper-button id="btnRegister" on-click="userRegister">Register</paper-button> <br />
      <paper-button id="btnReturn" on-click="return">Return</paper-button>
    </div>

    <div id="giphyTable">
      <iron-ajax
      id="ajax"
      url="http://api.giphy.com/v1/gifs/random?api_key=qKbUBixbIAeArAGoQX0FxkMm5T9hWj2P"
      params='{{getParams()}}'
      handle-as="json"
      on-response="handleGiphyResponse"
      debounce-duration="300"></iron-ajax>

      <div id="header">
        <h1>gif-bank.</h1>
        <div id="tabs">
            <button type="button">Favorites</button>
            <button type="button">Account</button>
            <button type="button">Settings</button>
        </div>
      </div>
  
      <h1>Search for gif</h1>
      <paper-input id="search" on-keypress="searchGif" label="Search"></paper-input>
      </br>
  
      <iron-list id="itemsList" items="[[giphyUrls]]" as="item" selection-enabled selected-items="{{selectedItem}}">
          <template>
              <div id="gif">
                  <img src="[[item]]" height="200" width="200">
              </div>
            </template>
      </iron-list>
    </div>

    <firebase-query
    path="/images/">
    </firebase-query>

    <div id="favorites">
      <h1>Favorites</h1>
      <iron-list id="favoriteList" items="[[giphyFav]]" as="item">
        <template>
          <div>
            <img src="[[item]]" height="200" width="200">
          </div>
        </template>
      </iron-list>
    </div>

    </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class UserLogin extends Polymer.Element {
      static get is() { return 'user-login'; }

      login() {
        var rootRef = firebase.database().ref();
        var userRef = rootRef.child("user");
        var email = this.$.loginEmail.value;
        var password = this.$.loginPassword.value;
        var localThis = this;
        //TODO: send the user credentials to see if 
        // it has a matching user

        // Searches the firebase for a user that holds 
        // 'email' and 'password'.
        userRef.orderByChild('email').equalTo(email).on("value", function(snapshot) {
          var fireBaseObj = snapshot.val()
          var user =  fireBaseObj[Object.keys(fireBaseObj)[0]];
          var firePass = user.password;
          if (user != null && firePass == password) {
            localStorage.setItem('email', email);
            localThis.$.login.style.display = 'none';
            localThis.$.giphyTable.style.display = 'block';
          }
          else {
            alert('invalid email or password');
          }
        });
      }

      searchGif(e) {
        if (13 === e.charCode) {
          let searchParam = this.$.search.value;
          console.log(searchParam)
          this.fireAjax(searchParam);
        }
      }

      handleGiphyResponse(e) {
        this.push('giphyUrls', e.detail.response.data.image_url)

        if(this.count != 1) {
            return
        }
        const numQueries = 12;

        for (var i = 0; i < numQueries - 1; i++) {
            this.$.ajax.generateRequest();
        }
        this.count++;
      }

      fireAjax(query) {
        this.set('giphyUrls', []);
        this.count = 1;
        this.$.ajax.set('params', {"tag": query });
        this.$.ajax.generateRequest();
      }

      return() {
        this.$.loginEmail.value = "";
        this.$.loginPassword.value = "";

        this.$.login.style.display = 'block';
        this.$.register.style.display = 'none';
      }

      register() {
        this.$.registerEmail.value = "";
        this.$.registerPassword.value = "";
        this.$.confirmPassword.value = "";

        this.$.login.style.display = 'none';
        this.$.register.style.display = 'block';
      }



      userRegister() {
        var email = this.$.registerEmail.value;
        var password = this.$.registerPassword.value;
        var confirmPassword = this.$.confirmPassword.value;

        if (email === "" || password === "" || confirmPassword === "") {
          return;
        }
        
        // checks if passwords are matching
        if (password === confirmPassword) {
          var rootRef = firebase.database().ref();
          var userRef = rootRef.child("user");
          var localThis = this;
          userRef.orderByChild('email').equalTo(email).on("value", function(snapshot) {
            var fireBaseObj = snapshot.val()
            if (!fireBaseObj) {
              userRef.push().set({email: email, password: password, files: []});
              localThis.$.login.style.display = 'block';
              localThis.$.register.style.display = 'none';
              localThis.$.userError.style.display = 'none';
              return;
            }
            var user =  fireBaseObj[Object.keys(fireBaseObj)[0]];
            localThis.$.userError.style.display = 'block';
            return;
          })
        }
      }

      _userUpdated(selectedItem) {
        var email = localStorage.getItem("email");
        var rootRef = firebase.database().ref();
        var userRef = rootRef.child("user");
        userRef.orderByChild('email').equalTo(email).on("value", function(snapshot) {
          var fireBaseObj = snapshot.val();
          if (fireBaseObj) {
            var user =  fireBaseObj[Object.keys(fireBaseObj)[0]];
          } 
        })
      }

      static get properties() {

        return {
          selectedItem: {
            type: Object,
            observer: '_userUpdated'
          }
        };
      }
    }

    window.customElements.define(UserLogin.is, UserLogin);
  </script>
</dom-module>